<h2>ACME Admin</h2>

<ul class="nav nav-tabs mb-3">
  <% const tabs = [
    ['orders','Orders', counts.orders],
    ['accounts','Accounts', counts.accounts],
    ['authzs','Authorizations', counts.authzs],
    ['challenges','Challenges', counts.challenges]
  ]; %>
  <% tabs.forEach(([slug,label,count]) => { %>
    <li class="nav-item">
      <a class="nav-link <%= tab===slug?'active':'' %>"
         href="/admin/acme?tab=<%= slug %>&q=<%= qEnc %>&pageSize=<%= pageSize %>&sortBy=<%= sortBy %>&sortDir=<%= sortDir %>">
         <%= label %> <span class="badge bg-secondary"><%= count %></span>
      </a>
    </li>
  <% }) %>
  </ul>

<form class="row gy-2 gx-2 align-items-end mb-3" method="get" action="/admin/acme">
  <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">
  <input type="hidden" name="tab" value="<%= tab %>">
  <div class="col-sm-6">
    <label class="form-label">Search</label>
    <input name="q" class="form-control" placeholder="kid, domain, status, token…" value="<%= q %>">
  </div>
  <div class="col-sm-2">
    <label class="form-label">Page size</label>
    <select name="pageSize" class="form-select">
      <% [10,20,50,100].forEach(sz => { %>
        <option value="<%= sz %>" <%= pageSize===sz?'selected':'' %>><%= sz %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Sort by</label>
    <select name="sortBy" class="form-select">
      <% let sortOpts = [];
         if (tab==='orders') sortOpts = [['created_at','Created'],['status','Status'],['id','ID']];
         if (tab==='accounts') sortOpts = [['created_at','Created'],['kid','KID'],['id','ID']];
         if (tab==='authzs') sortOpts = [['id','ID'],['status','Status'],['identifier_value','Identifier']];
         if (tab==='challenges') sortOpts = [['id','ID'],['status','Status'],['validated_at','Validated']];
         sortOpts.forEach(([v,l]) => { %>
          <option value="<%= v %>" <%= sortBy===v?'selected':'' %>><%= l %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Direction</label>
    <select name="sortDir" class="form-select">
      <option value="desc" <%= sortDir==='desc'?'selected':'' %>>Desc</option>
      <option value="asc"  <%= sortDir==='asc' ?'selected':'' %>>Asc</option>
    </select>
  </div>
  <div class="col-sm-12 col-md-2">
    <button class="btn btn-primary w-100" type="submit">Apply</button>
  </div>
  </form>

<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <caption class="visually-hidden">ACME <%= tab %> table with search, sorting, and paging</caption>
    <thead>
      <% if (tab==='orders') { %>
  <tr><th scope="col">ID</th><th scope="col">Status</th><th scope="col">Identifiers</th><th scope="col">Account (KID)</th><th scope="col">Created</th><th scope="col">Cert</th></tr>
      <% } else if (tab==='accounts') { %>
  <tr><th scope="col">ID</th><th scope="col">KID</th><th scope="col">Contacts</th><th scope="col">Orders</th><th scope="col">Created</th></tr>
      <% } else if (tab==='authzs') { %>
  <tr><th scope="col">ID</th><th scope="col">Order</th><th scope="col">Identifier</th><th scope="col">Status</th><th scope="col">URL</th></tr>
      <% } else { %>
  <tr><th scope="col">ID</th><th scope="col">Authz</th><th scope="col">Type</th><th scope="col">Token</th><th scope="col">Status</th><th scope="col">Identifier</th><th scope="col">Validated</th></tr>
      <% } %>
    </thead>
    <tbody>
      <% if (!rows.length) { %>
        <tr><td colspan="10" class="text-center text-muted py-4">No results.</td></tr>
      <% } %>

      <% rows.forEach(r => {
           function safeJSON(s) { try { return JSON.parse(s||''); } catch { return null; } }
           if (tab==='orders') {
             const ids = safeJSON(r.identifiers_json) || [];
             const idStr = ids.map(i=>`${i.type}:${i.value}`).join(', ');
      %>
        <tr>
          <td><code><%= r.id %></code></td>
          <td>
            <% if (r.status==='valid') { %><span class="badge bg-success">valid</span><% }
               else if (r.status==='ready') { %><span class="badge bg-primary">ready</span><% }
               else if (r.status==='pending') { %><span class="badge bg-warning text-dark">pending</span><% }
               else { %><span class="badge bg-danger"><%= r.status %></span><% } %>
          </td>
          <td class="text-truncate" style="max-width: 280px" title="<%= idStr %>"><%= idStr %></td>
          <td class="text-truncate" style="max-width: 320px" title="<%= r.kid %>"><code><%= r.kid %></code></td>
          <td><%= (r.created_at || '').replace('T',' ').replace('Z','') %></td>
          <td>
            <% if (r.has_cert) { %>
              <a class="btn btn-sm btn-outline-secondary" href="<%= r.cert_url %>" target="_blank" rel="noopener">Download</a>
            <% } else { %>
              <span class="text-muted">—</span>
            <% } %>
          </td>
        </tr>
      <% } else if (tab==='accounts') {
           const contacts = safeJSON(r.contact_json) || [];
           const cStr = contacts.join(', ');
      %>
        <tr>
          <td><code><%= r.id %></code></td>
          <td class="text-truncate" style="max-width: 420px" title="<%= r.kid %>"><code><%= r.kid %></code></td>
          <td class="text-truncate" style="max-width: 320px" title="<%= cStr %>"><%= cStr %></td>
          <td><%= r.orders_count %></td>
          <td><%= (r.created_at || '').replace('T',' ').replace('Z','') %></td>
        </tr>
      <% } else if (tab==='authzs') { %>
        <tr>
          <td><code><%= r.id %></code></td>
          <td><code>#<%= r.order_id %></code></td>
          <td><code><%= r.identifier_type %></code>: <%= r.identifier_value %></td>
          <td>
            <% if (r.status==='valid') { %><span class="badge bg-success">valid</span><% }
               else if (r.status==='pending') { %><span class="badge bg-warning text-dark">pending</span><% }
               else { %><span class="badge bg-danger"><%= r.status %></span><% } %>
          </td>
          <td class="text-truncate" style="max-width: 420px" title="<%= r.url %>"><%= r.url %></td>
        </tr>
      <% } else { %>
        <tr>
          <td><code><%= r.id %></code></td>
          <td><code>#<%= r.authz_id %></code> / order <code>#<%= r.order_id %></code></td>
          <td><code><%= r.type %></code></td>
          <td class="text-truncate" style="max-width: 220px" title="<%= r.token %>"><code><%= r.token %></code></td>
          <td>
            <% if (r.status==='valid') { %><span class="badge bg-success">valid</span><% }
               else if (r.status==='pending') { %><span class="badge bg-warning text-dark">pending</span><% }
               else if (r.status==='processing') { %><span class="badge bg-primary">processing</span><% }
               else { %><span class="badge bg-danger"><%= r.status %></span><% } %>
          </td>
          <td><%= r.identifier_value %></td>
          <td><%= r.validated_at ? r.validated_at.replace('T',' ').replace('Z','') : '—' %></td>
        </tr>
      <% } }) %>
    </tbody>
  </table>
  </div>

<% if (total > pageSize) { %>
<nav>
  <ul class="pagination">
    <% const base = `?tab=${tab}&q=${qEnc}&pageSize=${pageSize}&sortBy=${sortBy}&sortDir=${sortDir}`; %>
    <li class="page-item <%= page===1?'disabled':'' %>">
      <a class="page-link" href="<%= page===1 ? '#' : base + '&page=' + (page-1) %>" <%= page===1 ? 'aria-disabled=\"true\" tabindex=\"-1\"' : '' %>>Prev</a>
    </li>
    <% pages.forEach(p => { %>
      <li class="page-item <%= p===page?'active':'' %>">
        <a class="page-link" href="<%= base + '&page=' + p %>" <%= p===page ? 'aria-current=\"page\"' : '' %>><%= p %></a>
      </li>
    <% }) %>
    <li class="page-item <%= page===totalPages?'disabled':'' %>">
      <a class="page-link" href="<%= page===totalPages ? '#' : base + '&page=' + (page+1) %>" <%= page===totalPages ? 'aria-disabled=\"true\" tabindex=\"-1\"' : '' %>>Next</a>
    </li>
  </ul>
</nav>
<% } %>
