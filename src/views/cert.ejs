<h2>Issue TLS Certificate</h2>
<div id="flash-inline"></div>
<form id="issue-form" method="post" action="/certs/issue" class="row g-3">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <div class="col-md-6">
    <label class="form-label">Common Name</label>
    <input class="form-control" name="commonName" placeholder="api.internal.example" required>
  </div>
  <div class="col-md-6">
    <label class="form-label">Subject Alternative Names (comma-sep)</label>
    <input class="form-control" name="sans" placeholder="api.internal.example,10.0.0.12">
  </div>
  <div class="col-md-3">
    <label class="form-label">Validity (days)</label>
    <input class="form-control" name="days" type="number" value="365" min="1" max="825">
  </div>
  <div class="col-md-3">
    <label class="form-label">Key Type</label>
    <select name="keyType" class="form-select">
  <option>RSA</option>
  <option>EC</option>
    </select>
  </div>
  <div class="col-12">
  <button id="issue-submit" class="btn btn-primary" type="submit">Generate & Download</button>
  </div>
</form>
<script src="/public/js/cert.js"></script>

<hr class="my-4">
<h3 class="mb-3">Previously Issued Certificates</h3>
<div id="issued-list">

<form class="row gy-2 gx-2 align-items-end mb-3" method="get">
  <div class="col-sm-6">
    <label class="form-label">Search</label>
    <input name="q" class="form-control" placeholder="serial, CN, email, DNS, reasonâ€¦" value="<%= typeof q !== 'undefined' ? q : '' %>">
  </div>
  <div class="col-sm-2">
    <label class="form-label">Page size</label>
    <select name="pageSize" class="form-select">
      <% [10,20,50,100].forEach(sz => { %>
        <option value="<%= sz %>" <%= (typeof pageSize!== 'undefined' && pageSize===sz)?'selected':'' %>><%= sz %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Sort by</label>
    <select name="sortBy" class="form-select">
      <% const opts = [
        ['not_after','Not After'],
        ['not_before','Not Before'],
        ['subject_cn','CN'],
        ['serial_hex','Serial'],
        ['revoked_at','Revoked At'],
        ['renewed_from','Renewed From']
      ];
      const sb = typeof sortBy !== 'undefined' ? sortBy : 'not_after';
      opts.forEach(([val,label]) => { %>
        <option value="<%= val %>" <%= sb===val?'selected':'' %>><%= label %></option>
      <% }) %>
    </select>
  </div>
  <div class="col-sm-2">
    <label class="form-label">Direction</label>
    <select name="sortDir" class="form-select">
      <% const sd = typeof sortDir !== 'undefined' ? sortDir : 'desc'; %>
      <option value="desc" <%= sd==='desc'?'selected':'' %>>Desc</option>
      <option value="asc"  <%= sd==='asc' ?'selected':'' %>>Asc</option>
    </select>
  </div>
  <div class="col-sm-12 col-md-2">
    <button class="btn btn-secondary w-100" type="submit">Filter</button>
  </div>
  <% if (typeof q !== 'undefined' && q) { %>
    <div class="col-12">
      <a href="/certs/new" class="small">Clear filters</a>
    </div>
  <% } %>
  <% if (typeof total !== 'undefined') { %>
    <div class="col-12 text-muted small">Found <%= total %> certificate(s).</div>
  <% } %>
</form>

<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>Serial</th>
        <th>CN</th>
        <th>Not Before</th>
        <th>Not After</th>
        <th>SANs</th>
        <th>Revoked</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% if (!rows || !rows.length) { %>
        <tr><td colspan="6" class="text-center text-muted py-4">No certificates found.</td></tr>
      <% } %>
      <% (rows || []).forEach(r => { 
           const sans = r.sans_json ? JSON.parse(r.sans_json) : [];
           const sanStr = sans.map(s => s.value).join(', ');
      %>
        <tr>
          <td><code><%= r.serial_hex %></code></td>
          <td><%= r.subject_cn || '' %></td>
          <td><%= (r.not_before || '').replace('T',' ').replace('Z','') %></td>
          <td><%= (r.not_after  || '').replace('T',' ').replace('Z','') %></td>
          <td class="text-truncate" style="max-width: 280px" title="<%= sanStr %>"><%= sanStr %></td>
          <td>
            <% if (r.revoked_at) { %>
              <span class="badge bg-danger">Yes</span>
            <% } else { %>
              <span class="badge bg-success">No</span>
            <% } %>
          </td>
          <td>
            <% if (r.revoked_at) { %>
              <div class="small text-muted"><%= r.reason || '' %></div>
              <div class="small text-muted"><%= (r.revoked_at || '').replace('T',' ').replace('Z','') %></div>
            <% } else { %>
              <div class="d-flex gap-2 flex-wrap">
                <form class="d-inline" data-action="revoke" method="post" action="/certs/revoke">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="serial" value="<%= r.serial_hex %>">
                  <button type="submit" class="btn btn-sm btn-outline-danger">Revoke</button>
                </form>
                <a class="btn btn-sm btn-outline-secondary" href="/certs/renew?serial=<%= encodeURIComponent(r.serial_hex) %>" data-action="go-renew">Renew</a>
                <a class="btn btn-sm btn-outline-primary" href="/certs/by-serial/<%= encodeURIComponent(r.serial_hex) %>.pem">Download Cert</a>
              </div>
            <% } %>
          </td>
        </tr>
      <% }) %>
    </tbody>
  </table>
  
  <% if (typeof totalPages !== 'undefined' && totalPages > 1) { %>
  <nav>
    <ul class="pagination">
      <% const base = `?q=${typeof qEnc!=='undefined'?qEnc:encodeURIComponent(q||'')}&pageSize=${pageSize||10}&sortBy=${(sortBy||'not_after')}&sortDir=${(sortDir||'desc')}`; %>
      <li class="page-item <%= page===1?'disabled':'' %>">
        <a class="page-link" href="<%= page===1 ? '#' : base + '&page=' + (page-1) %>">Prev</a>
      </li>

      <% (pages||[]).forEach(p => { %>
        <li class="page-item <%= p===page?'active':'' %>">
          <a class="page-link" href="<%= base + '&page=' + p %>"><%= p %></a>
        </li>
      <% }) %>

      <li class="page-item <%= page===totalPages?'disabled':'' %>">
        <a class="page-link" href="<%= page===totalPages ? '#' : base + '&page=' + (page+1) %>">Next</a>
      </li>
    </ul>
  </nav>
  <% } %>
</div>
